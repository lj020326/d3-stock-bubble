// custom javascript
var fdata = [
  ["bubble1", [10, 20]],
  ["bubble2", [5, 7]],
  ["bubble3", [6, 6, 10]],
  ["bubble4", [12, 14]],
  ["bubble5", [14, 4]],
  ["bubble6", [15, 5, 10]],
  ["bubble7", [10, 10]],
  ["bubble8", [25, 10]],
  ["bubble9", [10, 25, 10, 10]],
  ["bubble10", [55, 10]],
  ["bubble11", [10, 80, 10, 10]],
  ["bubble12", [50, 50]]
];

fdata2 = {
  "results": [
    [
      "bubble1",
      [
        10,
        20
      ]
    ],
    [
      "bubble2",
      [
        5,
        7
      ]
    ],
    [
      "bubble3",
      [
        6,
        6,
        10
      ]
    ],
    [
      "bubble4",
      [
        12,
        14
      ]
    ],
    [
      "bubble5",
      [
        14,
        4
      ]
    ],
    [
      "bubble6",
      [
        15,
        5,
        10
      ]
    ],
    [
      "bubble7",
      [
        10,
        10
      ]
    ],
    [
      "bubble8",
      [
        25,
        10
      ]
    ],
    [
      "bubble9",
      [
        10,
        25,
        10,
        10
      ]
    ],
    [
      "bubble10",
      [
        55,
        10
      ]
    ],
    [
      "bubble11",
      [
        10,
        80,
        10,
        10
      ]
    ],
    [
      "bubble12",
      [
        50,
        50
      ]
    ]
  ]
};

fdata3={
    "children": [
      {
        "matched_data": [
          2230.0,
          7770.0
        ],
        "name": "Activision Blizzard Inc",
        "net_change": "0.9",
        "percent_change": "2.23",
        "price": "41.29",
        "symbol": "ATVI",
        "value": ".5",
        "volume": "6290931"
      },
      {
        "matched_data": [
          1730.0,
          8270.0
        ],
        "name": "Adobe Systems Incorporated",
        "net_change": "1.65",
        "percent_change": "1.73",
        "price": "96.79",
        "symbol": "ADBE",
        "value": ".7",
        "volume": "2023889"
      },
      {
        "matched_data": [
          2620.0,
          7380.0
        ],
        "name": "Akamai Technologies Inc.",
        "net_change": "1.44",
        "percent_change": "2.62",
        "price": "56.38",
        "symbol": "AKAM",
        "value": ".2",
        "volume": "1816181"
      },
      {
        "matched_data": [
          880.0,
          9120.0
        ],
        "name": "Alexion Pharmaceuticals Inc.",
        "net_change": "1.08",
        "percent_change": "0.88",
        "price": "124.42",
        "symbol": "ALXN",
        "value": ".2",
        "volume": "2447653"
      },
      {
        "matched_data": [
          1480.0,
          8520.0
        ],
        "name": "Alphabet Inc.",
        "net_change": "10.31",
        "percent_change": "1.48",
        "price": "705.67",
        "symbol": "GOOG",
        "value": "2.5",
        "volume": "1478453"
      },
      {
        "matched_data": [
          1490.0,
          8510.0
        ],
        "name": "Alphabet Inc.",
        "net_change": "10.52",
        "percent_change": "1.49",
        "price": "717.78",
        "symbol": "GOOGL",
        "value": ".0",
        "volume": "1497323"
      },
      {
        "matched_data": [
          1250.0,
          8750.0
        ],
        "name": "Amazon.com Inc.",
        "net_change": "9.24",
        "percent_change": "1.25",
        "price": "745.81",
        "symbol": "AMZN",
        "value": "3.7",
        "volume": "3429217"
      },
      {
        "matched_data": [
          2130.0,
          7870.0
        ],
        "name": "American Airlines Group Inc.",
        "net_change": "0.625",
        "percent_change": "2.13",
        "price": "30.025",
        "symbol": "AAL",
        "value": ".0",
        "volume": "13184141"
      },
      {
        "matched_data": [
          2880.0,
          7120.0
        ],
        "name": "Amgen Inc.",
        "net_change": "4.51",
        "percent_change": "2.88",
        "price": "161.1",
        "symbol": "AMGN",
        "value": "2.9",
        "volume": "3421112"
      },
      {
        "matched_data": [
          3200.0,
          6800.0
        ],
        "name": "Analog Devices Inc.",
        "net_change": "1.79",
        "percent_change": "3.2",
        "price": "57.74",
        "symbol": "ADI",
        "value": ".5",
        "volume": "2128148"
      },
      {
        "matched_data": [
          770.0,
          9230.0
        ],
        "name": "Apple Inc.",
        "net_change": "0.74",
        "percent_change": "0.77",
        "price": "96.68",
        "symbol": "AAPL",
        "value": ".6",
        "volume": "28912103"
      },
      {
        "matched_data": [
          2660.0,
          7340.0
        ],
        "name": "Applied Materials Inc.",
        "net_change": "0.645",
        "percent_change": "2.66",
        "price": "24.935",
        "symbol": "AMAT",
        "value": ".7",
        "volume": "13624427"
      },
      {
        "matched_data": [
          3010.0,
          6990.0
        ],
        "name": "Autodesk Inc.",
        "net_change": "1.61",
        "percent_change": "3.01",
        "price": "55.14",
        "symbol": "ADSK",
        "value": ".3",
        "volume": "1137122"
      },
      {
        "matched_data": [
          1040.0,
          8960.0
        ],
        "name": "Automatic Data Processing Inc.",
        "net_change": "0.97",
        "percent_change": "1.04",
        "price": "94.47",
        "symbol": "ADP",
        "value": ".4",
        "volume": "2148166"
      },
      {
        "matched_data": [
          -2220.0,
          12220.0
        ],
        "name": "Baidu Inc.",
        "net_change": "-3.62",
        "percent_change": "-2.22",
        "price": "159.8",
        "symbol": "BIDU",
        "value": "-.9",
        "volume": "6899544"
      },
      {
        "matched_data": [
          2470.0,
          7530.0
        ],
        "name": "Bed Bath &amp; Beyond Inc.",
        "net_change": "1.07",
        "percent_change": "2.47",
        "price": "44.46",
        "symbol": "BBBY",
        "value": ".2",
        "volume": "1849757"
      },
      {
        "matched_data": [
          1630.0,
          8370.0
        ],
        "name": "Biogen Inc.",
        "net_change": "4.03",
        "percent_change": "1.63",
        "price": "251.3",
        "symbol": "BIIB",
        "value": ".8",
        "volume": "1296446"
      },
      {
        "matched_data": [
          3810.0,
          6190.0
        ],
        "name": "BioMarin Pharmaceutical Inc.",
        "net_change": "3.36",
        "percent_change": "3.81",
        "price": "91.52",
        "symbol": "BMRN",
        "value": ".0",
        "volume": "3648354"
      },
      {
        "matched_data": [
          2750.0,
          7250.0
        ],
        "name": "Broadcom Limited",
        "net_change": "4.15",
        "percent_change": "2.75",
        "price": "155.14",
        "symbol": "AVGO",
        "value": ".9",
        "volume": "2514016"
      },
      {
        "matched_data": [
          590.0,
          9410.0
        ],
        "name": "Yahoo! Inc.",
        "net_change": "0.22",
        "percent_change": "0.59",
        "price": "37.74",
        "symbol": "YHOO",
        "value": ".2",
        "volume": "8786314"
      }
    ]
};



$(function() {
    console.log('jquery is working!');

    d3.json("/data3",function(error,data) {createGraph(data.children);});
    //d3.json("/data2",function(error,data) {createGraph(data.results);});
    //createGraph(fdata2.results);
    //createGraph(fdata3.children);
});


function createGraph(data) {
    var width = 960; // chart width
    var height = 700; // chart height
    var format = d3.format(",d");  // convert value to integer
    //var color = d3.scale.category20();  // create ordinal scale with 20 colors
    //var sizeOfRadius = d3.scale.pow().domain([-1,1]).range([-50,50]);  // https://github.com/mbostock/d3/wiki/Quantitative-Scales#pow

    var color = d3.scale.ordinal().range(["#f1eef6","#bdc9e1","#74a9cf","#0570b0"]);
    var diameter = 500;

    var bubble = d3.layout.pack()
          //.value(function(d) { return d3.sum(d[1]); })
          .value(function(d) { return d3.sum(d.matched_data); })
          .sort(null)
          .size([diameter, diameter])
          .padding(1.5),
          //.radius(function(d) { return 20 + (sizeOfRadius(d.value) * 40); }),  // radius for each circle
        arc = d3.svg.arc().innerRadius(0),
        pie = d3.layout.pie();

    var svg = d3.select("body").append("svg")
        .attr("width", diameter)
        .attr("height", diameter)
        .attr("class", "bubble");

    // tooltip config
    var tooltip = d3.select("body")
      .append("div")
      .style("position", "absolute")
      .style("z-index", "10")
      .style("visibility", "hidden")
      .style("color", "white")
      .style("padding", "8px")
      .style("background-color", "rgba(0, 0, 0, 0.75)")
      .style("border-radius", "6px")
      .style("font", "12px sans-serif")
      .text("tooltip");

    var nodes = svg.selectAll("g.node")
        .data(bubble.nodes({children: data}).filter(function(d) { return !d.children; }));

    nodes.enter().append("g")
        .attr("class", "node")
        .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });

    var arcGs = nodes.selectAll("g.arc")
        .data(function(d) {
          return pie(d.matched_data).map(function(m) { m.r = d.r; return m; });
        });

    var arcEnter = arcGs.enter().append("g").attr("class", "arc");

    arcEnter.append("path")
        .attr("d", function(d) {
          arc.outerRadius(d.r);
          arc.innerRadius(d.r/2);
          return arc(d);
        })
        .style("fill", function(d, i) { return color(i); });
        //.style("fill", function(d, i) { return color(d.symbol); });

    arcEnter.append("text")
        .attr({
          x: function(d) { arc.outerRadius(d.r); return arc.centroid(d)[0]; },
          y: function(d) { arc.outerRadius(d.r); return arc.centroid(d)[1]; },
          dy: "0.35em"
        })
        .style("text-anchor", "middle")
        .text(function(d) { return d.value; });


    //nodes.append("circle")
      //.attr("r", function(d) { return d.r; })
      //.style('fill', function(d) { return color(d.symbol); })

    nodes.on("mouseover", function(d) {
        tooltip.text(d.name + ": $" + d.price);
        tooltip.style("visibility", "visible");
      })
      .on("mousemove", function() {
        return tooltip.style("top", (d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px");
      })
      .on("mouseout", function(){return tooltip.style("visibility", "hidden");});

    var labels = nodes.selectAll("text.label")
        .data(function(d) { console.log(d); return [d.symbol]; });

    labels.enter().append("text")
        .attr({
          "class": "label",
          dy: "0.35em"
        })
        .style("text-anchor", "middle")
        .text(String);


}



